<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ماسح QR</title>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
        #reader { width: 100%; max-width: 400px; margin: auto; }
        #error-message { color: red; font-size: 18px; display: none; }
    </style>
</head>
<body>

    <p id="error-message">الرجاء فتح المتصفح الصحيح أو السماح للكاميرا لتشغيل الـ QR</p>
    <div id="reader"></div>
    <p id="result-container" style="display:none">نتيجة المسح: <span id="result"></span></p>

    <script>
        // ✅ التحقق من إذن الكاميرا قبل تشغيلها
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').innerText = "جهازك لا يدعم تشغيل الكاميرا. يرجى تحديث المتصفح.";
        } else {
            // ✅ التأكد أن الموقع يعمل عبر HTTPS
            if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
                alert("⚠ يجب تشغيل هذا الموقع عبر HTTPS لكي تعمل الكاميرا.");
            }

            // ✅ البحث عن الكاميرا الخلفية تلقائيًا
            Html5Qrcode.getCameras().then(devices => {
                if (devices.length === 0) {
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('error-message').innerText = "لم يتم العثور على كاميرا متاحة.";
                    return;
                }

                let backCamera = devices.find(device => device.label.toLowerCase().includes("back"));
                let cameraId = backCamera ? backCamera.id : devices[0].id; // اختيار الكاميرا الخلفية أو الأولى المتاحة

                // ✅ تشغيل ماسح QR بالكاميرا المحددة
                let qrScanner = new Html5Qrcode(cameraId);
                qrScanner.start(
                    cameraId,
                    {
                        fps: 10,
                        qrbox: { width: 300, height: 300 } // زيادة حجم المسح لحل مشاكل الهواتف
                    },
                    onScanSuccess,
                    onScanFailure
                );
            }).catch(err => {
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').innerText = "خطأ في الوصول إلى الكاميرا: " + err;
            });
        }

        // ✅ الدالة التي يتم استدعاؤها عند نجاح المسح
        function onScanSuccess(decodedText, decodedResult) {
            document.getElementById('result').innerText = decodedText; // عرض النتيجة
            document.getElementById('result-container').style.display = "block";

            // إرسال النتيجة إلى الصفحة الأصلية عبر postMessage
            if (window.opener) {
                window.opener.postMessage(decodedText, '*');
            }

            setTimeout(() => {
                window.close(); // إغلاق النافذة بعد 3 ثوانٍ
            }, 3000);
        }

        // ✅ الدالة التي يتم استدعاؤها عند فشل المسح
        function onScanFailure(error) {
            console.warn(`خطأ في المسح: ${error}`);
        }
    </script>

</body>
</html>
